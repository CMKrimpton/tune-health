---
// Floating Table of Contents for articles
// This is injected by JavaScript based on article headings
---

<nav class="floating-toc" id="floatingTOC" aria-label="Table of contents">
  <div class="floating-toc-header">
    <span class="text-xs font-semibold uppercase tracking-wider text-stone-500 dark:text-stone-400">Contents</span>
    <span class="floating-toc-progress text-xs text-primary-600" id="tocProgress">0%</span>
  </div>
  <ul class="floating-toc-list" id="tocList">
    <!-- Populated by JavaScript -->
  </ul>
  <button class="floating-toc-collapse" id="tocCollapse" aria-label="Collapse table of contents">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path d="M19 9l-7 7-7-7" stroke-width="2"/>
    </svg>
  </button>
</nav>

<style>
  .floating-toc {
    position: fixed;
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
    width: 200px;
    max-height: 60vh;
    background: rgb(255 255 255 / 0.95);
    backdrop-filter: blur(8px);
    border: 1px solid rgb(231 229 228);
    border-radius: 12px;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    z-index: 40;
    overflow: hidden;
  }

  :global(.dark) .floating-toc {
    background: rgb(28 25 23 / 0.95);
    border-color: rgb(68 64 60);
  }

  .floating-toc.visible {
    opacity: 1;
    visibility: visible;
  }

  .floating-toc.collapsed {
    width: auto;
    padding: 0.5rem;
  }

  .floating-toc.collapsed .floating-toc-header,
  .floating-toc.collapsed .floating-toc-list {
    display: none;
  }

  .floating-toc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgb(231 229 228);
  }

  :global(.dark) .floating-toc-header {
    border-color: rgb(68 64 60);
  }

  .floating-toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: calc(60vh - 80px);
    overflow-y: auto;
  }

  .floating-toc-list li {
    margin-bottom: 0.25rem;
  }

  .floating-toc-list a {
    display: block;
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    color: rgb(120 113 108);
    border-radius: 6px;
    transition: all 0.15s;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
  }

  .floating-toc-list a:hover {
    color: rgb(28 25 23);
    background: rgb(245 245 244);
  }

  :global(.dark) .floating-toc-list a:hover {
    color: rgb(250 250 249);
    background: rgb(41 37 36);
  }

  .floating-toc-list a.active {
    color: rgb(220 38 38);
    background: rgb(254 242 242);
    font-weight: 500;
  }

  :global(.dark) .floating-toc-list a.active {
    background: rgb(220 38 38 / 0.15);
  }

  .floating-toc-list a.is-h3 {
    padding-left: 1rem;
    font-size: 0.7rem;
  }

  .floating-toc-collapse {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    color: rgb(168 162 158);
    transition: all 0.15s;
  }

  .floating-toc-collapse:hover {
    background: rgb(245 245 244);
    color: rgb(87 83 78);
  }

  :global(.dark) .floating-toc-collapse:hover {
    background: rgb(41 37 36);
    color: rgb(168 162 158);
  }

  .floating-toc.collapsed .floating-toc-collapse svg {
    transform: rotate(180deg);
  }

  /* Mobile: show as a pill */
  @media (max-width: 1280px) {
    .floating-toc {
      right: 1rem;
      top: auto;
      bottom: 5rem;
      transform: none;
      width: auto;
      max-height: none;
      padding: 0.5rem 0.75rem;
    }

    .floating-toc-header,
    .floating-toc-list {
      display: none;
    }

    .floating-toc.visible {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .floating-toc::before {
      content: attr(data-section);
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .floating-toc-collapse {
      position: static;
      display: none;
    }
  }
</style>

<script>
  function initFloatingTOC() {
    const toc = document.getElementById('floatingTOC');
    const tocList = document.getElementById('tocList');
    const tocProgress = document.getElementById('tocProgress');
    const tocCollapse = document.getElementById('tocCollapse');

    if (!toc || !tocList) return;

    // Find all headings in the article
    const article = document.querySelector('article');
    if (!article) return;

    const headings = article.querySelectorAll('h2[id], h3[id]');
    if (headings.length < 3) {
      // Not enough headings to show TOC
      toc.remove();
      return;
    }

    // Build TOC list
    tocList.innerHTML = '';
    headings.forEach((heading) => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent;
      a.dataset.id = heading.id;
      if (heading.tagName === 'H3') {
        a.classList.add('is-h3');
      }
      a.addEventListener('click', (e) => {
        e.preventDefault();
        heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Show TOC after scrolling past hero
    const hero = document.querySelector('.article-hero');
    let tocVisible = false;

    const checkTOCVisibility = () => {
      const heroBottom = hero ? hero.getBoundingClientRect().bottom : 0;
      const shouldShow = heroBottom < 0;

      if (shouldShow !== tocVisible) {
        tocVisible = shouldShow;
        if (shouldShow) {
          toc.classList.add('visible');
        } else {
          toc.classList.remove('visible');
        }
      }
    };

    // Track active section
    const updateActiveSection = () => {
      let activeId = '';
      let activeTitle = '';
      const scrollPos = window.scrollY + 150;

      headings.forEach((heading) => {
        if ((heading as HTMLElement).offsetTop <= scrollPos) {
          activeId = heading.id;
          activeTitle = heading.textContent || '';
        }
      });

      // Update active link
      tocList.querySelectorAll('a').forEach((a) => {
        if (a.dataset.id === activeId) {
          a.classList.add('active');
        } else {
          a.classList.remove('active');
        }
      });

      // Update mobile pill text
      if (activeTitle) {
        toc.dataset.section = activeTitle;
      }

      // Update progress
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = Math.round((window.scrollY / docHeight) * 100);
      if (tocProgress) {
        tocProgress.textContent = `${progress}%`;
      }
    };

    // Scroll listener
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          checkTOCVisibility();
          updateActiveSection();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    // Collapse toggle
    tocCollapse?.addEventListener('click', () => {
      toc.classList.toggle('collapsed');
    });

    // Initial check
    checkTOCVisibility();
    updateActiveSection();
  }

  // Run on load
  initFloatingTOC();

  // Run after View Transitions
  document.addEventListener('astro:after-swap', initFloatingTOC);
</script>
